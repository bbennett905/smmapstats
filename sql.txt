CREATE TABLE IF NOT EXISTS `mapstats_servers` (
	server_id INT NOT NULL AUTO_INCREMENT,
	server_name VARCHAR(64),
	ip VARCHAR(16) NOT NULL UNIQUE,
	PRIMARY KEY (server_id)
);
CREATE TABLE IF NOT EXISTS `mapstats_maps` (
    map_id INT NOT NULL AUTO_INCREMENT,
    server_id INT NOT NULL,
    map_name VARCHAR(64) NOT NULL,
    connects INT NOT NULL DEFAULT 0,
    disconnects INT NOT NULL DEFAULT 0,
    PRIMARY KEY (map_id),
    FOREIGN KEY (server_id) REFERENCES mapstats_servers(server_id),
    UNIQUE KEY (server_id, map_name)
);
CREATE TABLE IF NOT EXISTS `mapstats_data` (
	data_id INT NOT NULL AUTO_INCREMENT,
	server_id INT NOT NULL, 
	map_id INT NOT NULL, 
	data_interval INT NOT NULL, 
	player_count INT NOT NULL,
	timestamp TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP, 
  	PRIMARY KEY (data_id), 
  	FOREIGN KEY (server_id) REFERENCES mapstats_servers(server_id),
    FOREIGN KEY (map_id) REFERENCES mapstats_maps(map_id)
);

INSERT INTO `mapstats_servers` (server_name, ip)
	VALUES ('some server name', '127.0.0.1')
	ON DUPLICATE KEY UPDATE
	server_name = 'another server name';
INSERT INTO `mapstats_servers` (server_name, ip)
	VALUES ('server number 2', '192.168.1.1')
	ON DUPLICATE KEY UPDATE
	server_name = 'another server name';
    
INSERT INTO `mapstats_maps` (map_name, server_id)
	VALUES (
        'map_name_goes_here',
        (SELECT server_id FROM `mapstats_servers` WHERE ip = '127.0.0.1')
    ) ON DUPLICATE KEY UPDATE map_name=map_name;
INSERT INTO `mapstats_maps` (map_name, server_id)
	VALUES (
        'map_name_goes_here',
        (SELECT server_id FROM `mapstats_servers` WHERE ip = '127.0.0.1')
    ) ON DUPLICATE KEY UPDATE map_name=map_name;
INSERT INTO `mapstats_maps` (map_name, server_id)
	VALUES (
        'map_name_goes_here',
        (SELECT server_id FROM `mapstats_servers` WHERE ip = '192.168.1.1')
    ) ON DUPLICATE KEY UPDATE map_name=map_name;
INSERT INTO `mapstats_maps` (map_name, server_id)
	VALUES (
        'map_name_2',
        (SELECT server_id FROM `mapstats_servers` WHERE ip = '127.0.0.1')
    ) ON DUPLICATE KEY UPDATE map_name=map_name;
 
INSERT INTO `mapstats_data`
	(server_id, map_id, data_interval, player_count)
	VALUES (
        (SELECT server_id FROM `mapstats_servers` WHERE ip = '127.0.0.1'),
		(SELECT map_id FROM `mapstats_maps` WHERE 
            map_name = 'map_name_goes_here' AND
            server_id = (SELECT server_id FROM `mapstats_servers` WHERE ip = '127.0.0.1')
        ),
		15,
		8
	);

INSERT INTO `mapstats_data`
	(server_id, map_id, data_interval, player_count)
	VALUES (
        (SELECT server_id FROM `mapstats_servers` WHERE ip = '127.0.0.1'),
		(SELECT map_id FROM `mapstats_maps` WHERE 
            map_name = 'map_name_goes_here' AND
            server_id = (SELECT server_id FROM `mapstats_servers` WHERE ip = '127.0.0.1')
        ),
		15,
		3
	);
INSERT INTO `mapstats_data`
	(server_id, map_id, data_interval, player_count)
	VALUES (
        (SELECT server_id FROM `mapstats_servers` WHERE ip = '127.0.0.1'),
		(SELECT map_id FROM `mapstats_maps` WHERE 
            map_name = 'map_name_2' AND
            server_id = (SELECT server_id FROM `mapstats_servers` WHERE ip = '127.0.0.1')
        ),
		15,
		8
	);
INSERT INTO `mapstats_data`
	(server_id, map_id, data_interval, player_count)
	VALUES (
        (SELECT server_id FROM `mapstats_servers` WHERE ip = '192.168.1.1'),
		(SELECT map_id FROM `mapstats_maps` WHERE 
            map_name = 'map_name_goes_here' AND
            server_id = (SELECT server_id FROM `mapstats_servers` WHERE ip = '192.168.1.1')
        ),
		15,
		8
	);
UPDATE `mapstats_maps` SET connects=connects+5 WHERE 
    map_name = 'map_name_goes_here' AND
    server_id = (SELECT server_id FROM `mapstats_servers` WHERE ip = '127.0.0.1');
UPDATE `mapstats_maps` SET disconnects=disconnects+5 WHERE 
    map_name = 'map_name_goes_here' AND
    server_id = (SELECT server_id FROM `mapstats_servers` WHERE ip = '192.168.1.1');




SELECT * FROM `mapstats_servers`;
SELECT * FROM `mapstats_maps`;
SELECT * FROM `mapstats_data`;

SELECT maps.map_name, 
    maps.connects, 
    maps.disconnects,
    SUM(data.player_count * data.data_interval), 
    SUM(data.data_interval), 
    COUNT(data.data_id)
    FROM `mapstats_maps` AS maps INNER JOIN `mapstats_data` AS data ON 
      (maps.map_id=data.map_id)
    WHERE maps.server_id = (SELECT server_id FROM `mapstats_servers` WHERE ip = '192.168.1.1')
    GROUP BY maps.map_name
    ORDER BY maps.map_name ASC;
SELECT maps.map_name, 
    maps.connects, 
    maps.disconnects,
    SUM(data.player_count * data.data_interval), 
    SUM(data.data_interval), 
    COUNT(data.data_id)
    FROM `mapstats_maps` AS maps INNER JOIN `mapstats_data` AS data ON 
      (maps.map_id=data.map_id)
    WHERE maps.server_id = (SELECT server_id FROM `mapstats_servers` WHERE ip = '127.0.0.1')
    GROUP BY maps.map_name
    ORDER BY maps.map_name ASC;